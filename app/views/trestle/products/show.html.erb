<% content_for :page_title do %>
  <%= @product.name %>
<% end %>

<div class="product-show">
  <div class="row">
    <div class="col-md-6">
      <div class="card">
        <div class="card-header">
          <h5>Основная информация</h5>
        </div>
        <div class="card-body">
          <table class="table">
            <tr>
              <th>SKU:</th>
              <td><%= @product.sku %></td>
            </tr>
            <tr>
              <th>Item No:</th>
              <td><%= @product.item_no %></td>
            </tr>
            <tr>
              <th>URL:</th>
              <td>
                <% if @product.url.present? %>
                  <%= link_to @product.url, @product.url, target: '_blank' %>
                <% else %>
                  <em class="text-muted">Нет URL</em>
                <% end %>
              </td>
            </tr>
            <tr>
              <th>Название (PL):</th>
              <td><%= @product.name %></td>
            </tr>
            <tr>
              <th>Название (RU):</th>
              <td><%= @product.name_ru || content_tag(:em, "Нет перевода", class: "text-muted") %></td>
            </tr>
            <tr>
              <th>Коллекция:</th>
              <td><%= @product.collection || content_tag(:em, "Нет", class: "text-muted") %></td>
            </tr>
            <tr>
              <th>Категория:</th>
              <td><%= @product.category&.name || 'Без категории' %></td>
            </tr>
            <tr>
              <th>Цена:</th>
              <td><%= @product.price ? number_to_currency(@product.price, unit: 'Zl', format: '%n %u') : content_tag(:em, "Нет", class: "text-muted") %></td>
            </tr>
            <tr>
              <th>В наличии:</th>
              <td><%= @product.quantity %></td>
            </tr>
            <tr>
              <th>Хит продаж:</th>
              <td>
                <span class="badge <%= @product.is_bestseller? ? 'badge-success' : 'badge-secondary' %>">
                  <%= @product.is_bestseller? ? 'Да' : 'Нет' %>
                </span>
              </td>
            </tr>
            <tr>
              <th>Популярный:</th>
              <td>
                <span class="badge <%= @product.is_popular? ? 'badge-success' : 'badge-secondary' %>">
                  <%= @product.is_popular? ? 'Да' : 'Нет' %>
                </span>
              </td>
            </tr>
          </table>
        </div>
      </div>
    </div>

    <div class="col-md-6">
      <div class="card">
        <div class="card-header">
          <h5>Характеристики</h5>
        </div>
        <div class="card-body">
          <table class="table">
            <tr>
              <th>Вес:</th>
              <td><%= @product.weight ? "#{@product.weight} кг" : content_tag(:em, "Нет", class: "text-muted") %></td>
            </tr>
            <tr>
              <th>Чистый вес:</th>
              <td><%= @product.net_weight ? "#{@product.net_weight} кг" : content_tag(:em, "Нет", class: "text-muted") %></td>
            </tr>
            <tr>
              <th>Объём упаковки:</th>
              <td><%= @product.package_volume ? "#{@product.package_volume} л" : content_tag(:em, "Нет", class: "text-muted") %></td>
            </tr>
            <tr>
              <th>Размеры упаковки:</th>
              <td><%= @product.package_dimensions || content_tag(:em, "Нет", class: "text-muted") %></td>
            </tr>
            <tr>
              <th>Размеры:</th>
              <td><%= @product.dimensions || content_tag(:em, "Нет", class: "text-muted") %></td>
            </tr>
            <tr>
              <th>Посылка:</th>
              <td>
                <span class="badge <%= @product.is_parcel? ? 'badge-success' : 'badge-secondary' %>">
                  <%= @product.is_parcel? ? 'Да' : 'Нет' %>
                </span>
              </td>
            </tr>
            <tr>
              <th>Оисание:</th>
              <td><%= @product.content_ru&.html_safe || content_tag(:em, "Нет описания", class: "text-muted") %></td>
            </tr>
          </table>
        </div>
      </div>
    </div>
  </div>

  <div class="row mt-4">
    <div class="col-12">
      <div class="card">
        <div class="card-header">
          <h5>Картинки продукта</h5>
        </div>
        <div class="card-body">
          <% 
            # Получаем remote images
            remote_images = if @product.images.is_a?(Array)
                              @product.images
                            elsif @product.images.is_a?(String) && @product.images.present?
                              begin
                                JSON.parse(@product.images)
                              rescue
                                []
                              end
                            else
                              []
                            end
            # Фильтруем пустые, nil, false и строку "false" значения
            remote_images = Array(remote_images).compact.reject { |url| 
              url.blank? || 
              url == false || 
              url == 'false' || 
              !url.is_a?(String) ||
              url.to_s.downcase == 'false'
            }

            # Получаем local images
            local_images = if @product.local_images.is_a?(Array)
                             @product.local_images
                           elsif @product.local_images.is_a?(String) && @product.local_images.present?
                             begin
                               parsed = JSON.parse(@product.local_images)
                               # Если это массив массивов, распаковываем
                               parsed.is_a?(Array) ? parsed.flatten : [parsed]
                             rescue
                               []
                             end
                           else
                             []
                           end
            # Фильтруем и нормализуем пути - гарантируем, что каждый элемент это строка
            local_images = Array(local_images).flatten.compact.map { |path|
              # Преобразуем в строку
              path_str = path.to_s.strip
              # Убираем кавычки и скобки, если они есть
              path_str = path_str.gsub(/^["\[\]]+|["\[\]]+$/, '').strip
              path_str
            }.reject { |path_str|
              # Отфильтровываем пустые, false, 'false'
              path_str.blank? || 
              path_str == false || 
              path_str == 'false' || 
              path_str.to_s.downcase == 'false' ||
              !path_str.is_a?(String)
            }
          %>

          <% if remote_images.any? || local_images.any? %>
            <% if remote_images.any? %>
              <h6 class="mt-3">Удалённые картинки (<%= remote_images.length %>)</h6>
              <div class="row mb-4">
                <% remote_images.each do |image_url| %>
                  <% next unless image_url.present? && image_url.is_a?(String) && image_url != 'false' && image_url.to_s.downcase != 'false' %>
                  <div class="col-sm-3 col-md-2 mb-3">
                    <div class="product-image-thumbnail" style="border: 1px solid #ddd; border-radius: 4px; padding: 5px; text-align: center;">
                      <%= link_to image_url, target: '_blank', title: image_url do %>
                        <%= image_tag(image_url, class: 'img-fluid', style: 'max-width: 100%; height: auto;', onerror: "this.style.display='none'; this.parentElement.innerHTML='<em class=\\'text-muted\\'>Ошибка загрузки</em>';") %>
                      <% end %>
                    </div>
                  </div>
                <% end %>
              </div>
            <% end %>

            <% if local_images.any? %>
              <h6 class="mt-3">Локальные картинки (<%= local_images.length %>)</h6>
              <div class="row mb-4">
                <% local_images.each do |image_path| %>
                  <% 
                    # Строгая обработка image_path - гарантируем, что это строка
                    # Если это массив, берем первый элемент
                    if image_path.is_a?(Array)
                      image_path = image_path.first
                    end
                    
                    # Преобразуем в строку и убираем кавычки и скобки
                    image_path = image_path.to_s.strip
                    image_path = image_path.gsub(/^["\[\]]+|["\[\]]+$/, '').strip
                    
                    # Пропускаем если пусто или не строка
                    next if image_path.blank? || !image_path.is_a?(String)
                    
                    # Формируем полный путь
                    full_path = image_path.start_with?('/') ? image_path : "/#{image_path}"
                    
                    # Финальная проверка - full_path должен быть строкой
                    next unless full_path.is_a?(String) && full_path.present?
                  %>
                  <div class="col-sm-3 col-md-2 mb-3">
                    <div class="product-image-thumbnail" style="border: 1px solid #ddd; border-radius: 4px; padding: 5px; text-align: center;">
                      <%= link_to full_path.to_s, target: '_blank', title: image_path do %>
                        <%= image_tag(full_path.to_s, class: 'img-fluid', style: 'max-width: 100%; height: auto;', onerror: "this.style.display='none'; this.parentElement.innerHTML='<em class=\\'text-muted\\'>Ошибка загрузки</em>';") %>
                      <% end %>
                    </div>
                  </div>
                <% end %>
              </div>
            <% end %>
          <% else %>
            <p class="text-muted">Картинки не загружены</p>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <% 
    # Получаем связанные продукты
    related_products = if @product.related_products.is_a?(Array)
                         @product.related_products
                       elsif @product.related_products.is_a?(String) && @product.related_products.present?
                         begin
                           JSON.parse(@product.related_products)
                         rescue
                           []
                         end
                       else
                         []
                       end
    
    set_items = if @product.set_items.is_a?(Array)
                  @product.set_items
                elsif @product.set_items.is_a?(String) && @product.set_items.present?
                  begin
                    JSON.parse(@product.set_items)
                  rescue
                    []
                  end
                else
                  []
                end
    
    bundle_items = if @product.bundle_items.is_a?(Array)
                     @product.bundle_items
                   elsif @product.bundle_items.is_a?(String) && @product.bundle_items.present?
                     begin
                       JSON.parse(@product.bundle_items)
                     rescue
                       []
                     end
                   else
                     []
                   end
  %>
  
  <% if related_products.any? || set_items.any? || bundle_items.any? %>
    <div class="row mt-4">
      <div class="col-12">
        <div class="card">
          <div class="card-header">
            <h5>Связанные продукты</h5>
          </div>
          <div class="card-body">
            <% if related_products.any? %>
              <h6 class="mb-3">Рекомендуемые товары (<%= related_products.length %>)</h6>
              <div class="mb-4">
                <ul class="list-group">
                  <% related_products.each do |item_no| %>
                    <% related_product = Product.find_by(item_no: item_no) || Product.find_by(sku: item_no) %>
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                      <% if related_product %>
                        <%= link_to "#{related_product.name} (#{item_no})", "/admin/products/#{related_product.id}", class: 'text-decoration-none' %>
                        <span class="badge badge-primary badge-pill"><%= related_product.price ? number_to_currency(related_product.price, unit: 'Zl', format: '%n %u') : 'N/A' %></span>
                      <% else %>
                        <span><%= item_no %></span>
                        <span class="badge badge-secondary badge-pill">Не найден</span>
                      <% end %>
                    </li>
                  <% end %>
                </ul>
              </div>
            <% end %>
            
            <% if set_items.any? %>
              <h6 class="mb-3">Элементы набора (<%= set_items.length %>)</h6>
              <div class="mb-4">
                <ul class="list-group">
                  <% set_items.each do |item_no| %>
                    <% set_product = Product.find_by(item_no: item_no) || Product.find_by(sku: item_no) %>
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                      <% if set_product %>
                        <%= link_to "#{set_product.name} (#{item_no})", "/admin/products/#{set_product.id}", class: 'text-decoration-none' %>
                        <span class="badge badge-primary badge-pill"><%= set_product.price ? number_to_currency(set_product.price, unit: 'Zl', format: '%n %u') : 'N/A' %></span>
                      <% else %>
                        <span><%= item_no %></span>
                        <span class="badge badge-secondary badge-pill">Не найден</span>
                      <% end %>
                    </li>
                  <% end %>
                </ul>
              </div>
            <% end %>
            
            <% if bundle_items.any? %>
              <h6 class="mb-3">Элементы комплекта (<%= bundle_items.length %>)</h6>
              <div class="mb-4">
                <ul class="list-group">
                  <% bundle_items.each do |item_no| %>
                    <% bundle_product = Product.find_by(item_no: item_no) || Product.find_by(sku: item_no) %>
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                      <% if bundle_product %>
                        <%= link_to "#{bundle_product.name} (#{item_no})", "/admin/products/#{bundle_product.id}", class: 'text-decoration-none' %>
                        <span class="badge badge-primary badge-pill"><%= bundle_product.price ? number_to_currency(bundle_product.price, unit: 'Zl', format: '%n %u') : 'N/A' %></span>
                      <% else %>
                        <span><%= item_no %></span>
                        <span class="badge badge-secondary badge-pill">Не найден</span>
                      <% end %>
                    </li>
                  <% end %>
                </ul>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  <% end %>

  <% if @product.delivery_type.present? || @product.delivery_name.present? || @product.delivery_cost.present? %>
    <div class="row mt-4">
      <div class="col-12">
        <div class="card">
          <div class="card-header">
            <h5>Доставка</h5>
          </div>
          <div class="card-body">
            <table class="table">
              <tr>
                <th>Тип доставки:</th>
                <td><%= @product.delivery_type || content_tag(:em, "Нет", class: "text-muted") %></td>
              </tr>
              <tr>
                <th>Название доставки:</th>
                <td><%= @product.delivery_name || content_tag(:em, "Нет", class: "text-muted") %></td>
              </tr>
              <tr>
                <th>Стоимость доставки:</th>
                <td><%= @product.delivery_cost ? number_to_currency(@product.delivery_cost, unit: 'Zl', format: '%n %u') : content_tag(:em, "Нет", class: "text-muted") %></td>
              </tr>
              <tr>
                <th>Причина доставки:</th>
                <td><%= @product.delivery_reason || content_tag(:em, "Нет", class: "text-muted") %></td>
              </tr>
            </table>
          </div>
        </div>
      </div>
    </div>
  <% end %>
</div>

<style>
  .product-image-thumbnail {
    transition: transform 0.2s;
  }
  .product-image-thumbnail:hover {
    transform: scale(1.05);
  }
  .product-image-thumbnail img {
    cursor: pointer;
  }
</style>

