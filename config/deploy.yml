# Kamal (MRSK) конфигурация для деплоя
# Документация: https://kamal-deploy.org

service: ikea_api

# Docker образ (должен включать username для Docker Hub)
image: sushi0590/ikea_api

# Примечание: Kamal автоматически использует текущий git репозиторий
# из директории, где запускается команда kamal deploy

# SSH пользователь для подключения к серверам
ssh:
  user: deploy

# Серверы для деплоя
servers:
  web:
    hosts:
      - 45.135.234.22
    # Kamal автоматически публикует порт 3000
    # Healthcheck настроен через Docker HEALTHCHECK в Dockerfile
    # Nginx НЕ обязателен - Kamal использует kamal-proxy для маршрутизации
    # Указываем порт для kamal-proxy
    proxy:
      port: 3000

# Docker registry (требуется для Kamal)
# Docker Hub registry
registry:
  server: docker.io
  username: sushi0590
  password:
    - KAMAL_REGISTRY_PASSWORD
  # Пароль должен быть указан в .kamal/secrets как KAMAL_REGISTRY_PASSWORD
  # Используйте Docker Hub Personal Access Token

# Builder конфигурация
builder:
  context: .
  dockerfile: Dockerfile
  arch: amd64

# Переменные окружения
env:
  clear:
    RAILS_ENV: production
    DB_HOST: ikea_api-postgres
    DB_PORT: 5432
    REDIS_URL: redis://ikea_api-redis:6379/0
    MONGODB_URI: mongodb://ikea_api-mongodb:27017/ikea
  secret:
    - RAILS_MASTER_KEY
    - DB_USERNAME
    - DB_PASSWORD
    - REDIS_PASSWORD
    - JWT_SECRET
    - POSTGRES_PASSWORD

# Volumes для хранения данных
volumes:
  - storage:/rails/storage

# Дополнительные сервисы (accessories)
accessories:
  postgres:
    image: postgres:16
    host: 45.135.234.22
    port: 5432
    env:
      clear:
        POSTGRES_DB: ikea_api_production
      secret:
        - POSTGRES_PASSWORD
    directories:
      - postgres-data:/var/lib/postgresql/data

  redis:
    image: redis:7-alpine
    host: 45.135.234.22
    port: 6379
    directories:
      - redis-data:/data

  mongodb:
    image: mongo:7
    host: 45.135.234.22
    port: 27017
    directories:
      - mongodb-data:/data/db
